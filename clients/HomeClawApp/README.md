# HomeClaw Companion (Flutter)

Companion app for **HomeClaw Core**: chat from Mac, Windows, Linux, Android, and iOS. Connects to Core via HTTP (POST /inbound). **One codebase for all platforms;** native features use **homeclaw_native** (notifications, screen record, camera, etc.) and **homeclaw_voice** (voice input via [speech_to_text](https://pub.dev/packages/speech_to_text)). See `packages/homeclaw_native` and `packages/homeclaw_voice`. Feature parity with OpenClaw is planned in phases; see **docs_design/HomeClawFlutterFeatureParityWithOpenClaw.md** and **docs_design/FlutterCompanionNativePlugins.md**.

## Prerequisites

- **Flutter SDK** 3.0+ ([flutter.dev](https://flutter.dev)).
- **HomeClaw Core** running (e.g. `http://127.0.0.1:9000`).

## First-time setup: generate platform folders

This project includes **android/, ios/, macos/, windows/, linux/** (generated by `flutter create .`). If you cloned a repo that only had `lib/` and `pubspec.yaml`, run once:

```bash
cd clients/HomeClawApp
flutter create . --platforms=ios,android,macos,windows,linux
```

Then:

```bash
flutter pub get
```

## Windows: NuGet required (flutter_tts)

The **flutter_tts** plugin needs **nuget.exe** to build on Windows. If you see `nuget.exe not found`:

1. **Download nuget.exe:** [https://dist.nuget.org/win-x86-commandline/latest/nuget.exe](https://dist.nuget.org/win-x86-commandline/latest/nuget.exe)
2. **Put it on your PATH:** e.g. save to `C:\tools` (or any folder) and add that folder to your system **PATH**.
3. Or run the helper script once (from this directory): `.\scripts\ensure_nuget.ps1` — it downloads nuget.exe into `tools/` and adds it to PATH for the current session.

Then run `flutter run -d windows` again.

## Run by platform

- **macOS:** `flutter run -d macos`
- **Windows:** `flutter run -d windows` (requires nuget.exe on PATH; see above)
- **Linux:** `flutter run -d linux` (requires Linux dev libraries; see [Flutter Linux](https://docs.flutter.dev/platform-integration/linux))
- **Android:** `flutter run -d android` (device or emulator)
- **iOS:** `flutter run -d ios` (device or simulator; requires Xcode on Mac)

To list devices: `flutter devices`.

## Build macOS app for distribution (let users run it directly)

**One command to build a DMG (from repo root):**
```bash
./scripts/build_companion_dmg.sh
```
Output: `dist/HomeClawApp.dmg`. Optional: `--output /path/to/Companion.dmg`.

To produce a **standalone macOS app** manually (or just the .app without DMG):

1. **From the Companion app directory:**
   ```bash
   cd clients/HomeClawApp
   flutter pub get
   flutter build macos --release
   ```

2. **Built app location:**  
   The app bundle is at:
   ```text
   build/macos/Build/Products/Release/HomeClawApp.app
   ```

3. **Give it to users:**  
   - **Option A:** Copy `HomeClawApp.app` to the user’s Mac (e.g. drag to **Applications** or send via zip). They double-click to open.  
   - **Option B:** Create a DMG (e.g. with `hdiutil` or a tool like [create-dmg](https://github.com/create-dmg/create-dmg)) and distribute the DMG; users open it and drag the app to Applications.

4. **First launch (unsigned / not notarized):**  
   If the app is not signed or notarized, macOS may show "**HomeClawApp cannot be opened because the developer cannot be verified**". The user can:  
   - **Right‑click (or Control‑click)** the app → **Open** → **Open** in the dialog, or  
   - **System Settings → Privacy & Security** → under “Security” allow the app once.  
   To avoid that for many users, **sign and notarize** the app (Apple Developer account, then `codesign` + `xcrun notarytool`); see [Flutter macOS deployment](https://docs.flutter.dev/deployment/macos) and [Apple notarization](https://developer.apple.com/documentation/security/notarizing_macos_software_before_distribution).

5. **Optional: Apple-style icon on the built app**  
   See [App icon (Apple style)](#app-icon-apple-style) and run `./scripts/macos_icon_squircle.sh` after building if you use Option B there.

## App usage

1. **First launch:** Open **Settings** (gear icon), set **Core URL** (e.g. `http://127.0.0.1:9000`). If Core has `auth_enabled: true`, set **API Key**. Tap **Save**.
2. **Scan to connect (mobile):** On the machine where Core runs, run `homeclaw pair` (or `python homeclaw_cli.py pair`). In the app, open **Settings** → **Scan QR to connect** and scan the QR. The app saves the URL and API key and returns to Settings.
3. **Chat:** Type a message and send; the reply from Core appears below. Use the **mic** button for voice input (on Linux requires Vosk; see below).

## Features (⋯ menu in chat)

| Feature | What it’s for | How to use |
|--------|----------------|------------|
| **Take photo** | Attach a photo to your next message so Core can “see” it (vision). | Tap **Take photo**. On **iOS/Android** the camera opens; on **macOS** you pick a photo from the gallery (camera not used). The photo is added as an attachment—type a message if you like, then **Send**. |
| **Record video** | Attach a short video to your next message (Core can use it like images). | Tap **Record video**. On **iOS/Android** you can record; on **macOS** you **select an existing video** from the gallery. Then **Send** to include it. |
| **Record screen** | Capture your screen as a short video and attach it to your next message. | Tap **Record screen**. The app records for ~10 seconds, then adds the recording as an attachment. **macOS:** Grant **Screen Recording** in System Settings → Privacy & Security first. **Send** to include it. |
| **Run command** | Run a shell command on your machine and see the output in chat (desktop only). | **Settings** → **Exec allowlist** → add allowed commands (e.g. `ls`, `pwd`, or a regex like `^/usr/bin/.*`). Then in chat, **⋯** → **Run command**, enter e.g. `ls -la`, tap Run. Result appears as a message. |
| **Speak last reply** | Hear the last assistant reply read aloud (TTS). | Tap **Speak last reply** after you have a reply. Uses system text-to-speech. |

**Why “Take photo” / “Record video” open the file picker on macOS:** On macOS the in-app camera isn’t used for these actions; you **choose an existing photo or video** from your files instead. On iPhone/Android, Take photo opens the camera and Record video can record a new video.

## Linux: voice input (Vosk)

On Linux, voice uses [Vosk](https://alphacephei.com/vosk/) (offline). Install deps and a model, then set `VOSK_MODEL`:

```bash
pip install vosk sounddevice
# Download e.g. vosk-model-small-en-us-0.15 and unzip
export VOSK_MODEL=/path/to/vosk-model-small-en-us-0.15
```

See `packages/homeclaw_voice/README.md` for details.

## Remote Core (iOS/Android/desktop when Core is at home)

HomeClaw **supports remote connection**: use **Tailscale** (recommended), Cloudflare Tunnel, or SSH. In Settings set **Core URL** to the exposed URL (e.g. Tailscale: `http://100.x.x.x:9000` or `https://your-machine.tailnet-name.ts.net`). No Tailscale/Cloudflare SDK in the app — just one URL + API key. See **docs_design/RemoteConnectionIOSAndroidDesktop.md** for details and QR-pairing (optional) for one-tap mobile setup.

## Android: HTTP (non-HTTPS) Core

If Core is HTTP (e.g. local `http://192.168.x.x:9000`), Android 9+ blocks cleartext by default. Either:

- Use an HTTPS URL (e.g. via tunnel), or
- Add cleartext: create or edit `android/app/src/main/res/xml/network_security_config.xml` with cleartext allowed, and in `AndroidManifest.xml` set `android:networkSecurityConfig="@xml/network_security_config"` and `android:usesCleartextTraffic="true"` on the `<application>` tag.

(See [Flutter network security](https://docs.flutter.dev/development/data-and-backend/network-security) for details.)

## macOS permissions (do we need to “turn on” permissions like OpenClaw?)

**Current app (chat only):** You do **not** need to turn on extra macOS permissions. The app only talks to Core over HTTP; no Accessibility, Screen Recording, Microphone, Notifications, or Automation. No TCC prompts for the current feature set.

**If you add features later** (e.g. voice input, notifications, screen capture): You may need the same kinds of permissions as [OpenClaw’s Mac app](https://open-claw.bot/docs/platforms/mac/permissions) (Notifications, Accessibility, Screen Recording, Microphone, etc.). For that, use proper signing, a stable bundle ID, and a fixed app path; see **docs_design/MacOSCompanionPermissions.md** for a full guide and TCC reset steps.

**Network / signing:** For release or sandbox, ensure **Outgoing Connections (Client)** is enabled in `macos/Runner/*.entitlements`. See **docs_design/MacOSCompanionPermissions.md** for details.

## iOS / macOS: network and signing

- **Simulator:** Usually works with default settings.
- **Real device / release:** Configure signing in Xcode (macOS: enable "Outgoing Connections" in entitlements if needed). For iOS, add any required capabilities (e.g. network).

## QR scan and permissions (iOS / Android)

**Scan to connect** and **Take photo** use the camera; **Notifications** and **voice input** need their own permissions.

- **iOS:**  
  - Info.plist already has `NSCameraUsageDescription`, `NSMicrophoneUsageDescription`, `NSSpeechRecognitionUsageDescription`.  
  - The **permission_handler** plugin requires **GCC_PREPROCESSOR_DEFINITIONS** in `ios/Podfile` for each permission (camera, notifications, microphone, speech). Without them, the system permission dialogs do not appear. The project Podfile includes these. After changing Podfile run `cd ios && pod install`.  
  - If a permission was previously denied, the dialog won’t show again; use **Settings → Homeclaw Companion** to enable, or tap **Open Settings** on the permissions screen.
- **Android:** `AndroidManifest.xml` declares camera, microphone, notifications; `permission_handler` and `mobile_scanner` handle prompts. If the app asks and is denied, grant in system settings.

On **macOS/Windows** the scanner may not have a camera; use manual URL entry in Settings.

## App icon (Apple style)

- **Regenerate base icons:** `dart run flutter_launcher_icons` (from `clients/HomeClawApp`). Source: `assets/icon/app_icon.png`.
- **iOS:** The system applies the squircle mask automatically. Use a **square** source image (e.g. 1024×1024), fully opaque, with **no rounded corners drawn** in the image. Do a clean build and reinstall if the icon doesn’t update.
- **macOS:** The system does **not** apply the squircle automatically, so the icon stays square unless you do one of the following:

  **Option A – Bake rounded corners into the project (recommended)**  
  After `dart run flutter_launcher_icons`, run:
  ```bash
  ./scripts/macos_icon_squircle_assets.sh
  ```
  Requires ImageMagick: `brew install imagemagick`. This overwrites the macOS icon assets with rounded-corner PNGs so **every build** (Debug and Release) has the Apple-style icon. Then run `flutter run -d macos` or `flutter build macos`.

  **Option B – Apply squircle to the built app only**  
  1. Install [iconsur](https://github.com/rikumi/iconsur): `brew install iconsur`.
  2. Build or run the app once (e.g. `flutter build macos` or `flutter run -d macos`).
  3. Run `./scripts/macos_icon_squircle.sh` (for Release) or `./scripts/macos_icon_squircle.sh Debug` (if you run from IDE). Enter your password when prompted for `iconsur cache`.
  4. The icon updates only for that built `.app`; rebuilds will use the square icon again unless you run the script again.

## Troubleshooting

- **Connection refused:** Ensure Core is running and the URL in Settings is correct (no trailing slash).
- **401 / 403:** Enable and set the API key in Settings to match Core’s `auth_api_key`.
- **Platform build fails:** Run `flutter doctor` and fix any reported issues. Ensure you ran `flutter create .` and `flutter pub get`.
- **Android: "Remote host terminated the handshake" / Could not resolve ... (TLS):** Gradle can’t download dependencies. The project’s `android/gradle.properties` already sets `-Dhttps.protocols=TLSv1.2,TLSv1.3`. Use **JDK 17** for the build (`java -version`; set `JAVA_HOME` if needed). If you’re behind a corporate proxy or firewall, configure its CA or use a working network. Then run `flutter clean`, `flutter pub get`, and `flutter build apk` (or `flutter run -d android`) again.
- **iOS: "Command PhaseScriptExecution failed with a nonzero exit code":** One of the Xcode Run Script phases failed. **Quick fix:** from the Companion app directory run `./scripts/ios_ready.sh` (or: `flutter pub get` then `cd ios && pod install && cd ..`). Then build with `flutter run -d ios` or open **`ios/Runner.xcworkspace`** in Xcode and build. To see **which** phase failed: in Xcode open the Report navigator (⌘9), select the last build, expand the failed step—you’ll see either "Run Script" (need `FLUTTER_ROOT` → run `flutter pub get`) or "[CP] Check Pods Manifest.lock" (run `cd ios && pod install`).
- **Windows: "nuget.exe not found":** The flutter_tts plugin needs NuGet. See [Windows: NuGet required](#windows-nuget-required-flutter_tts) above.
- **Windows: MSB3073 / "cmake_install.cmake exited with code 1":** Often fixed by: (1) **Clean build:** run `flutter clean`, then `flutter pub get`, then `flutter run -d windows`. (2) **Windows SDK:** In Visual Studio Installer → Modify → Individual components, ensure a **Windows 10 SDK** (or Windows 11 SDK) is installed; then run `flutter clean` and build again. (3) If it still fails, try building from a **shorter path** (e.g. `C:\hc` instead of a long path) to avoid MAX_PATH issues.
- **QR scan fails or no camera:** On desktop use manual URL in Settings. On mobile grant camera permission.