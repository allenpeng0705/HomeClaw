<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HomeClaw Canvas</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 640px; margin: 1rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; }
    .session-row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem; }
    .session-row input { flex: 1; padding: 0.5rem; }
    .session-row button { padding: 0.5rem 1rem; }
    .status { color: #666; font-size: 0.875rem; margin-bottom: 1rem; }
    .canvas-title { font-weight: 600; margin-bottom: 0.5rem; }
    .canvas-blocks { border: 1px solid #ddd; border-radius: 6px; padding: 1rem; min-height: 80px; }
    .block { margin: 0.5rem 0; }
    .block-text { white-space: pre-wrap; }
    .block-button { display: inline-block; padding: 0.4rem 0.8rem; background: #333; color: #fff; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem; margin-top: 0.25rem; }
    .block-button:hover { background: #555; }
    .empty { color: #999; }
  </style>
</head>
<body>
  <h1>HomeClaw Canvas</h1>
  <div class="session-row">
    <label for="session">Session:</label>
    <input type="text" id="session" value="default" placeholder="default or user_id" />
    <button type="button" id="connect">Connect</button>
  </div>
  <div class="status" id="status">Disconnected. Enter session and click Connect.</div>
  <div class="canvas-title" id="docTitle"></div>
  <div class="canvas-blocks" id="blocks">
    <span class="empty">No canvas content yet. The agent can push UI via canvas_update.</span>
  </div>

  <script>
    const sessionInput = document.getElementById('session');
    const connectBtn = document.getElementById('connect');
    const statusEl = document.getElementById('status');
    const docTitleEl = document.getElementById('docTitle');
    const blocksEl = document.getElementById('blocks');

    let ws = null;

    function setStatus(msg, ok = true) {
      statusEl.textContent = msg;
      statusEl.style.color = ok ? '#666' : '#c00';
    }

    function render(doc) {
      if (!doc) {
        docTitleEl.textContent = '';
        blocksEl.innerHTML = '<span class="empty">No canvas content yet. The agent can push UI via canvas_update.</span>';
        return;
      }
      docTitleEl.textContent = doc.title || '';
      const blocks = doc.blocks || [];
      if (blocks.length === 0) {
        blocksEl.innerHTML = '<span class="empty">(empty)</span>';
        return;
      }
      blocksEl.innerHTML = blocks.map(b => {
        if (b.type === 'text') {
          return '<div class="block block-text">' + escapeHtml(String(b.content || '')) + '</div>';
        }
        if (b.type === 'button') {
          return '<div class="block"><button type="button" class="block-button" data-id="' + escapeHtml(b.id || '') + '">' + escapeHtml(b.label || 'Button') + '</button></div>';
        }
        return '<div class="block">' + escapeHtml(JSON.stringify(b)) + '</div>';
      }).join('');
      blocksEl.querySelectorAll('.block-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          setStatus('Clicked: ' + (id || btn.textContent));
        });
      });
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function connect() {
      if (ws) { ws.close(); ws = null; }
      const session = (sessionInput.value || '').trim() || 'default';
      const base = window.location.origin.replace(/^http/, 'ws');
      const url = base + '/canvas-ws?session=' + encodeURIComponent(session);
      setStatus('Connectingâ€¦');
      ws = new WebSocket(url);
      ws.onopen = () => setStatus('Connected to session: ' + session);
      ws.onclose = () => { setStatus('Disconnected.', false); ws = null; }
      ws.onerror = () => setStatus('WebSocket error.', false);
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type === 'canvas_update' && msg.document) render(msg.document);
        } catch (e) {}
      };
    }

    connectBtn.addEventListener('click', connect);
  </script>
</body>
</html>
